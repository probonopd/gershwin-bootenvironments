#!/bin/sh

# Test script to check if MiniBus replies work
# Start minibus daemon
./obj/minibus &
DAEMON_PID=$!

sleep 1

# Use netcat to test raw connection
echo "Testing raw D-Bus Hello exchange..."
{
    # Send D-Bus auth
    printf "\0AUTH EXTERNAL 31303031\r\nNEGOTIATE_UNIX_FD\r\nBEGIN\r\n"
    sleep 0.1
    
    # Send Hello message (128 bytes from our working test)
    printf "\x6c\x01\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x6e\x00\x00\x00\x01\x01\x6f\x00\x15\x00\x00\x00\x2f\x6f\x72\x67\x2f\x66\x72\x65\x65\x64\x65\x73\x6b\x74\x6f\x70\x2f\x44\x42\x75\x73\x00\x00\x00\x06\x01\x73\x00\x14\x00\x00\x00\x6f\x72\x67\x2e\x66\x72\x65\x65\x64\x65\x73\x6b\x74\x6f\x70\x2e\x44\x42\x75\x73\x00\x00\x00\x00\x02\x01\x73\x00\x14\x00\x00\x00\x6f\x72\x67\x2e\x66\x72\x65\x65\x64\x65\x73\x6b\x74\x6f\x70\x2e\x44\x42\x75\x73\x00\x00\x00\x00\x03\x01\x73\x00\x05\x00\x00\x00\x48\x65\x6c\x6c\x6f\x00\x00\x00"
    
    sleep 1
} | nc -U /tmp/minibus-socket | hexdump -C

kill $DAEMON_PID
wait $DAEMON_PID 2>/dev/null
